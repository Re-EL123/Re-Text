<!DOCTYPE html>
<html lang="en" ng-app="bulkSmsApp">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk SMS Sender</title>

  <!-- AngularJS + ngAnimate + Angular Material -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular-animate.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular-aria.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.3/angular-material.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.3/angular-material.min.css">

  <style>
    body {
      font-family: Roboto, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    md-toolbar {
      background: #3f51b5;
      color: white;
    }
    .container {
      max-width: 700px;
      margin: 30px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    md-input-container {
      width: 100%;
    }
    md-list-item {
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    md-list-item button {
      min-width: 24px;
      padding: 0 8px;
    }
    .status {
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #dff0d8;
      color: #3c763d;
    }
    .error {
      background-color: #f2dede;
      color: #a94442;
    }
    .fade.ng-enter, .fade.ng-leave {
      transition: 0.5s all ease;
      opacity: 0;
    }
    .fade.ng-enter-active, .fade.ng-leave-active {
      opacity: 1;
    }
  </style>
</head>
<body ng-controller="SmsController as smsCtrl">

  <!-- Toolbar -->
  <md-toolbar>
    <div class="md-toolbar-tools">
      <h2>Bulk SMS Sender</h2>
    </div>
  </md-toolbar>

  <div class="container" layout="column">

    <!-- Service Status -->
    <md-card>
      <md-card-content>
        <p>Service Status: 
          <span ng-class="{'success': serviceAvailable, 'error': !serviceAvailable}">
            {{ serviceAvailable ? 'Available' : 'Unavailable' }}
          </span>
        </p>
      </md-card-content>
    </md-card>

    <!-- Country Code Selector -->
    <md-input-container>
      <label>Country Code</label>
      <md-select ng-model="countryCode" placeholder="+27">
        <md-option value="+27">+27 (South Africa)</md-option>
        <md-option value="+1">+1 (USA)</md-option>
        <md-option value="+44">+44 (UK)</md-option>
        <md-option value="+91">+91 (India)</md-option>
        <md-option value="+61">+61 (Australia)</md-option>
      </md-select>
    </md-input-container>

    <!-- Add Numbers -->
    <md-input-container>
      <label>Enter numbers (one per line, without country code)</label>
      <textarea ng-model="newNumbers" rows="5" placeholder="e.g. 761234567"></textarea>
    </md-input-container>
    <md-button class="md-raised md-primary" ng-click="addNumbers()">Add Numbers</md-button>

    <!-- Numbers List -->
    <h4>Saved Numbers</h4>
    <md-list>
      <md-list-item ng-repeat="number in numbers track by $index" class="fade">
        {{ number }}
        <md-button class="md-icon-button md-warn" ng-click="removeNumber($index)" aria-label="Remove">
          &times;
        </md-button>
      </md-list-item>
    </md-list>

    <!-- Message -->
    <md-input-container>
      <label>Message</label>
      <textarea ng-model="message" rows="4" placeholder="Type your message"></textarea>
    </md-input-container>
    <md-button class="md-raised md-accent" ng-click="sendSms()">Send SMS</md-button>

    <!-- Status -->
    <div class="status" ng-if="smsStatus" ng-class="{'success': smsSent, 'error': !smsSent}">
      {{ smsStatus }}
    </div>

  </div>

  <script>
    const SMS_API_URL = 'https://textflow-sms-api.p.rapidapi.com/send-sms';
    const CHECK_API_URL = 'https://textflow-sms-api.p.rapidapi.com/service/check';
    const RAPIDAPI_KEY = '82ae10db11mshb41ccacdd991130p108a22jsnf3ae22b94bbd';

    angular.module('bulkSmsApp', ['ngMaterial', 'ngAnimate'])
      .controller('SmsController', ['$scope', '$timeout', function($scope, $timeout) {
        $scope.numbers = JSON.parse(localStorage.getItem('numbers')) || [];
        $scope.newNumbers = '';
        $scope.message = '';
        $scope.smsStatus = '';
        $scope.smsSent = false;
        $scope.serviceAvailable = false;
        $scope.countryCode = '+27'; // default

        // Check service availability
        async function checkService() {
          try {
            const response = await fetch(CHECK_API_URL, {
              method: 'POST',
              headers: {
                'x-rapidapi-key': RAPIDAPI_KEY,
                'x-rapidapi-host': 'textflow-sms-api.p.rapidapi.com',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ testing: 'true' })
            });
            const result = await response.json();
            $scope.$apply(() => $scope.serviceAvailable = result.status === 'success');
          } catch (err) {
            console.error(err);
            $scope.$apply(() => $scope.serviceAvailable = false);
          }
        }
        checkService();

        // Add numbers with country code
        $scope.addNumbers = function() {
          if (!$scope.newNumbers) return;
          const nums = $scope.newNumbers.split('\n')
            .map(n => n.trim())
            .filter(Boolean)
            .map(n => $scope.countryCode + n.replace(/^0+/, '')); // prepend country code
          $scope.numbers = [...new Set([...$scope.numbers, ...nums])];
          localStorage.setItem('numbers', JSON.stringify($scope.numbers));
          $scope.newNumbers = '';
        };

        // Remove number
        $scope.removeNumber = function(index) {
          $scope.numbers.splice(index, 1);
          localStorage.setItem('numbers', JSON.stringify($scope.numbers));
        };

        // Send SMS
        $scope.sendSms = async function() {
          if (!$scope.message) {
            $scope.smsStatus = 'Please enter a message.';
            $scope.smsSent = false;
            return;
          }
          if ($scope.numbers.length === 0) {
            $scope.smsStatus = 'No numbers to send SMS.';
            $scope.smsSent = false;
            return;
          }

          $scope.smsStatus = 'Sending...';
          $scope.smsSent = false;

          let successCount = 0;

          for (const number of $scope.numbers) {
            try {
              const response = await fetch(SMS_API_URL, {
                method: 'POST',
                headers: {
                  'x-rapidapi-key': RAPIDAPI_KEY,
                  'x-rapidapi-host': 'textflow-sms-api.p.rapidapi.com',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  data: {
                    phone_number: number,
                    text: $scope.message,
                    api_key: 'your_api_key'
                  }
                })
              });
              const result = await response.json();
              if (result.status === 'success') successCount++;
            } catch (err) {
              console.error('Error sending to', number, err);
            }
          }

          $scope.$apply(() => {
            $scope.smsStatus = `SMS sent to ${successCount}/${$scope.numbers.length} numbers.`;
            $scope.smsSent = successCount === $scope.numbers.length;
          });

          // Save message history
          const history = JSON.parse(localStorage.getItem('smsHistory') || '[]');
          history.push({ message: $scope.message, numbers: $scope.numbers, timestamp: new Date() });
          localStorage.setItem('smsHistory', JSON.stringify(history));

          $scope.message = '';
        };
      }]);
  </script>
</body>
</html>
